# 建账规则助手 - 项目开发计划

> **更新时间**: 2025年1月
> **项目进度**: ~85% 完成
> **当前状态**: 核心功能已实现，等待数据库配置和完整测试

---

## 📊 项目概况

### 项目目标
将Dify上的5个工作流智能体一键迁移到Coze平台，并实现所有原有功能，新增RAG知识检索能力和自定义RAG策略。

### 技术栈
- **框架**: LangChain + LangGraph 1.0
- **大模型**: 豆包 deepseek-v3-2-251201
- **Embedding**: 豆包 doubao-embedding-large-text-250515
- **向量存储**: PostgreSQL + PGVector
- **Web框架**: Flask + WebSocket
- **全文检索**: rank-bm25
- **文档处理**: unstructured + python-docx + pypdf

### 核心功能
1. ✅ 角色识别和路由（产品经理/技术开发/销售运营/默认工程师）
2. ✅ 文档处理和规则提取
3. ✅ 智能问答（RAG知识检索）
4. ✅ 反馈处理和记录
5. ✅ 实时协作会话（WebSocket）
6. ✅ 自定义RAG策略（问题分类、BM25、混合检索、智能路由）
7. ✅ Web可视化界面

---

## ✅ 已完成功能清单

### 1. Dify工作流迁移（100%）
- [x] Master_Router（主路由Agent）
- [x] 文档处理工作流
- [x] QA问答工作流
- [x] 反馈处理工作流
- [x] 角色识别工作流

**实现文件**:
- `src/agents/agent.py` - 主Agent，包含角色路由和工具调用
- `config/agent_llm_config.json` - Agent配置（包含System Prompt）

### 2. 核心工具开发（100%）

#### 基础工具（12个）
- [x] `document_processor` - 文档处理和规则提取
- [x] `validate_rules` - 规则校验
- [x] `qa_agent` - QA问答工具
- [x] `classify_query` - 查询分类工具
- [x] `feedback_handler` - 反馈处理
- [x] `generate_summary_report` - 反馈汇总
- [x] `write_to_file` - 写入本地文件
- [x] `write_to_storage` - 写入对象存储
- [x] `save_rule_to_knowledge` - 保存规则到知识库
- [x] `save_qa_answer` - 保存问答对
- [x] `read_from_storage` - 从对象存储读取
- [x] `list_storage_files` - 列出文件

#### RAG基础工具（9个）
- [x] `load_document` - 加载文档（Markdown/Word）
- [x] `load_documents_with_metadata` - 批量加载文档
- [x] `get_document_info` - 获取文档信息
- [x] `split_text_recursive` - 递归文本分割
- [x] `split_text_by_markdown_structure` - Markdown结构分割
- [x] `split_document_optimized` - 优化文档分割
- [x] `split_text_with_summary` - 分割并统计
- [x] `rerank_documents` - 文档重排序
- [x] `check_vector_store_setup` - 检查向量存储设置

#### 知识库管理工具（4个）
- [x] `add_document_to_knowledge_base` - 添加文档到知识库
- [x] `delete_documents_from_knowledge_base` - 删除文档
- [x] `search_knowledge_base` - 搜索知识库
- [x] `get_knowledge_base_stats` - 获取统计信息

#### RAG检索工具（1个）
- [x] `rag_retrieve_with_rerank` - RAG检索（向量+Rerank）

### 3. RAG策略功能（100% - 代码实现）

#### 问题类型分类器（7种类型）
- [x] `classify_question_type` - 问题分类工具
  - concept（概念型）：什么是XXX
  - process（流程型）：如何做XXX
  - compare（对比型）：XXX和YYY的区别
  - factual（事实型）：XXX的数据、日期
  - rule（规则型）：XXX的规则、规定
  - troubleshooting（故障排查）：XXX出现错误
  - general（通用型）：其他问题

- [x] `get_retrieval_strategy` - 获取推荐检索策略
  - 根据问题类型推荐最优检索方法
  - 支持策略：vector, bm25, hybrid, hybrid_rerank

#### 全文检索
- [x] `bm25_retrieve` - BM25全文检索
  - 中文分词支持
  - 索引缓存机制
  - 可配置的参数（top_k、collection_name）

#### 混合检索
- [x] `hybrid_retrieve` - 混合检索（向量+BM25）
  - 加权融合（vector_weight, bm25_weight）
  - RRF（倒数排名融合）
  - 支持Rerank重排序

#### 智能路由
- [x] `smart_retrieve` - 智能检索路由
  - 自动分类问题类型
  - 自动选择最优策略
  - 支持手动指定策略

#### 高级功能
- [x] `compare_retrieval_methods` - 检索方法对比
  - 对比4种方法的效果
  - 返回详细统计数据

- [x] `batch_retrieve` - 批量检索
  - 支持多查询并行处理
  - 自动选择策略
  - 返回详细结果

- [x] `get_retrieval_statistics` - 检索统计
  - 策略使用统计
  - 问题类型分布
  - 平均性能指标

### 4. Web可视化界面（100% - 前端实现）

#### 聊天界面
- [x] `src/web/templates/chat.html` - 主聊天界面
- [x] `src/web/static/script.js` - 聊天交互脚本
- [x] `src/web/static/style.css` - 聊天样式

#### 协作会话界面
- [x] `src/web/templates/collaboration.html` - 协作会话页面
- [x] `src/web/static/collaboration.js` - 协作交互脚本
- [x] `src/web/static/collaboration.css` - 协作样式
- [x] `src/web/collaboration_service.py` - WebSocket服务
- [x] 实时消息广播
- [x] 多用户在线状态显示
- [x] 简单昵称输入

#### RAG配置界面
- [x] `src/web/templates/rag_config.html` - RAG配置页面
- [x] `src/web/static/rag_config.js` - RAG配置脚本
- [x] `src/web/static/rag_config.css` - RAG配置样式

### 5. Web API端点（100%）

#### 聊天API
- [x] `GET /` - 聊天页面
- [x] `POST /api/chat` - 聊天API（SSE流式）
- [x] `POST /api/reset` - 重置对话
- [x] `POST /api/set_role` - 设置角色
- [x] `GET /api/status` - 获取状态

#### 协作API
- [x] `GET /collaboration` - 协作页面
- [x] `GET/POST /api/collaboration/sessions` - 管理会话
- [x] `GET/DELETE /api/collaboration/sessions/<id>` - 管理单个会话
- [x] `GET/POST /api/collaboration/sessions/<id>/participants` - 管理参与者
- [x] `GET /api/collaboration/sessions/<id>/messages` - 获取消息
- [x] `POST /api/collaboration/chat` - 协作聊天API
- [x] WebSocket `/ws/collaboration/<session_id>` - 实时通信

#### RAG配置API
- [x] `GET /rag-config` - RAG配置页面
- [x] `POST /api/rag/classify` - 问题分类API
- [x] `POST /api/rag/strategy` - 获取推荐策略API
- [x] `POST /api/rag/retrieve` - 执行检索API
- [x] `POST /api/rag/compare` - 检索方法对比API
- [x] `POST /api/rag/statistics` - 检索统计API
- [x] `POST /api/rag/batch` - 批量检索API

### 6. 测试和代码质量（90%）
- [x] `tests/test_rag_strategy.py` - RAG策略测试脚本
- [x] 测试用例覆盖：问题分类、BM25检索、混合检索、智能路由、批量检索、检索统计
- [x] 修复所有LSP检查错误（类型注解、导入问题）
- [x] 修复所有工具调用错误（'StructuredTool' object is not callable）
- [x] 安装依赖包（rank-bm25）

---

## ⏳ 待完成功能清单

### 优先级1：数据库配置（阻塞项）

#### 1.1 PostgreSQL + PGVector配置
**状态**: 未开始
**预计时间**: 2-3小时
**依赖**: 无
**任务**:
- [ ] 配置PostgreSQL数据库连接
- [ ] 创建数据库和表结构
- [ ] 配置PGVector扩展
- [ ] 测试向量存储功能
- [ ] 添加示例文档到知识库

**详细步骤**:
1. 设置数据库环境变量（或修改`src/tools/vector_store.py`）
2. 创建PostgreSQL数据库和用户
3. 启用PGVector扩展: `CREATE EXTENSION vector;`
4. 创建必要的表（如果需要）
5. 测试`get_vector_store()`函数
6. 上传示例Markdown文档到`assets/`目录
7. 运行`add_document_to_knowledge_base`添加文档
8. 运行`search_knowledge_base`验证检索功能

**验证标准**:
- 能够成功连接数据库
- 能够创建向量集合
- 能够添加文档并生成向量
- 能够执行相似度搜索

---

### 优先级2：完整功能测试

#### 2.1 RAG策略功能端到端测试
**状态**: 部分完成（问题分类✅、BM25✅，混合检索/智能路由⏳）
**预计时间**: 3-4小时
**依赖**: 1.1 数据库配置
**任务**:
- [ ] 测试混合检索（向量+BM25）
- [ ] 测试智能检索路由
- [ ] 测试检索方法对比
- [ ] 测试批量检索
- [ ] 测试检索统计
- [ ] 修复发现的bug

**详细测试用例**:
```python
# 混合检索测试
query = "建账的基本原则"
result = hybrid_retrieve(
    query=query,
    collection_name="knowledge_base",
    top_k=5,
    vector_weight=0.5,
    bm25_weight=0.5,
    use_rerank=False
)
# 验证：结果包含vector_score和bm25_score

# 智能路由测试
queries = [
    "什么是建账？",              # concept -> vector
    "如何进行凭证审核？",       # process -> hybrid
    "现金日记账和银行存款日记账的区别是什么？",  # compare -> hybrid_rerank
    "固定资产折旧率是多少？",    # factual -> bm25
]
for query in queries:
    result = smart_retrieve(query=query)
    # 验证：策略选择正确
```

**验证标准**:
- 混合检索返回融合后的分数
- 智能路由根据问题类型选择正确策略
- 对比功能返回4种方法的详细对比
- 批量检索处理多个查询
- 统计功能返回准确的数据

#### 2.2 Web界面RAG配置功能测试
**状态**: 未开始
**预计时间**: 2-3小时
**依赖**: 1.1 数据库配置、2.1 RAG策略测试
**任务**:
- [ ] 测试问题分类API（/api/rag/classify）
- [ ] 测试检索API（/api/rag/retrieve）
- [ ] 测试对比API（/api/rag/compare）
- [ ] 测试统计API（/api/rag/statistics）
- [ ] 测试批量检索API（/api/rag/batch）
- [ ] 测试前端交互和响应

**详细步骤**:
1. 启动Web服务: `python src/web/app.py`
2. 打开浏览器访问 `/rag-config`
3. 测试问题分类功能
4. 测试不同策略的检索功能
5. 测试检索方法对比
6. 测试批量检索
7. 验证所有API响应正确

**验证标准**:
- 所有API端点响应正常
- 前端界面显示正确
- 检索结果准确展示
- 错误处理完善

---

### 优先级3：知识库管理功能

#### 3.1 知识库管理基础功能
**状态**: 部分实现（工具已开发，Web界面缺失）
**预计时间**: 4-6小时
**依赖**: 1.1 数据库配置
**任务**:
- [ ] 创建知识库管理Web页面
- [ ] 实现文档上传功能
- [ ] 实现文档列表展示
- [ ] 实现文档删除功能
- [ ] 实现文档搜索功能
- [ ] 实现知识库统计展示

**功能清单**:
1. 文档上传
   - 支持拖拽上传
   - 支持.md、.docx、.pdf格式
   - 显示上传进度
   - 自动解析和分块

2. 文档管理
   - 列出所有文档
   - 显示文档元数据（上传时间、大小、chunk数）
   - 删除单个文档
   - 批量删除
   - 搜索文档

3. 知识库统计
   - 总文档数
   - 总chunk数
   - 最近更新时间
   - 按类别统计

**UI设计**:
```
┌─────────────────────────────────────────┐
│  知识库管理                                │
├─────────────────────────────────────────┤
│  📤 上传文档  📊 统计信息  🔍 搜索       │
├─────────────────────────────────────────┤
│  文档列表：                               │
│  ┌─────────────────────────────────┐   │
│  │ 📄 建账规则.md                 │   │
│  │    上传时间: 2025-01-10        │   │
│  │    Chunk数: 15                │   │
│  │    [查看详情] [删除]          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 📄 凭证审核流程.docx           │   │
│  │    上传时间: 2025-01-09        │   │
│  │    Chunk数: 28                │   │
│  │    [查看详情] [删除]          │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**API端点**:
- `GET /knowledge-base` - 知识库管理页面
- `POST /api/kb/upload` - 上传文档
- `GET /api/kb/documents` - 获取文档列表
- `DELETE /api/kb/documents/<id>` - 删除文档
- `GET /api/kb/stats` - 获取统计信息

#### 3.2 文档分层结构（父子目录）
**状态**: 未开始
**预计时间**: 3-4小时
**依赖**: 3.1 知识库管理基础功能
**任务**:
- [ ] 设计文档分类和目录结构
- [ ] 实现目录创建/删除功能
- [ ] 实现文档移动功能
- [ ] 实现拖拽排序
- [ ] 更新Web界面显示目录结构

**功能清单**:
1. 目录管理
   - 创建多级目录
   - 重命名目录
   - 删除目录（级联删除子目录和文档）
   - 移动目录

2. 文档分类
   - 为文档指定分类/目录
   - 按目录筛选文档
   - 支持多级目录结构

**数据结构设计**:
```json
{
  "id": 1,
  "name": "建账规则",
  "parent_id": null,
  "children": [
    {
      "id": 2,
      "name": "基础规则",
      "parent_id": 1,
      "children": [
        {
          "id": 3,
          "name": "凭证管理",
          "parent_id": 2,
          "children": []
        }
      ]
    },
    {
      "id": 4,
      "name": "审核流程",
      "parent_id": 1,
      "children": []
    }
  ]
}
```

#### 3.3 分段预览功能
**状态**: 未开始
**预计时间**: 2-3小时
**依赖**: 3.1 知识库管理基础功能
**任务**:
- [ ] 实现文档分段列表展示
- [ ] 实现分段内容预览
- [ ] 实现分段编辑功能
- [ ] 实现分段删除功能
- [ ] 实现分段重新分割

**功能清单**:
1. 分段列表
   - 显示所有分段
   - 显示分段元数据（序号、字符数、相似度范围）
   - 搜索分段

2. 分段预览
   - 点击分段显示完整内容
   - 高亮关键词
   - 显示相似度分数

3. 分段操作
   - 编辑分段内容
   - 删除分段
   - 合并相邻分段
   - 重新分割文档

#### 3.4 Web界面重构为知识库管理页
**状态**: 未开始
**预计时间**: 2-3小时
**依赖**: 3.1, 3.2, 3.3
**任务**:
- [ ] 整合所有知识库管理功能到统一页面
- [ ] 设计响应式布局
- [ ] 优化用户体验
- [ ] 添加帮助文档和引导

---

### 优先级4：特色功能

#### 4.1 知识热力图
**状态**: 未开始
**预计时间**: 4-6小时
**依赖**: 2.1 RAG策略测试
**任务**:
- [ ] 实现问题频率统计
- [ ] 实现热点问题识别
- [ ] 实现热力图可视化
- [ ] 实现时间趋势分析

**功能清单**:
1. 问题统计
   - 记录所有查询
   - 统计问题出现频率
   - 分类统计（按问题类型）

2. 热点识别
   - 识别最常问的问题（Top 10）
   - 识别问题类型分布
   - 识别用户关注点变化

3. 可视化
   - 热力图展示（文档级别、chunk级别）
   - 柱状图（问题类型分布）
   - 折线图（时间趋势）

**API端点**:
- `GET /api/heatmap/documents` - 文档热力图数据
- `GET /api/heatmap/questions` - 问题频率统计
- `GET /api/heatmap/trend` - 时间趋势分析

**UI设计**:
```
┌─────────────────────────────────────────┐
│  知识热力图                               │
├─────────────────────────────────────────┤
│  📊 统计概览                              │
│  - 总查询数: 1,234                      │
│  - 热点问题: 15                        │
│  - 覆盖文档: 23                        │
├─────────────────────────────────────────┤
│  🔥 热点问题 Top 10                      │
│  1. 如何进行凭证审核？（234次）         │
│  2. 建账的基本原则是什么？（189次）     │
│  3. 余额不平衡如何处理？（156次）       │
├─────────────────────────────────────────┤
│  📈 问题类型分布                         │
│  [柱状图]                               │
├─────────────────────────────────────────┤
│  🗺️ 文档热力图                          │
│  [热力图可视化]                          │
└─────────────────────────────────────────┘
```

#### 4.2 答案溯源链
**状态**: 未开始
**预计时间**: 3-4小时
**依赖**: 2.1 RAG策略测试
**任务**:
- [ ] 实现答案来源追踪
- [ ] 实现文档段落高亮
- [ ] 实现点击跳转
- [ ] 实现置信度显示

**功能清单**:
1. 溯源信息
   - 记录答案引用的文档
   - 记录引用的段落（chunk）
   - 记录相似度分数

2. 可视化展示
   - 显示引用的文档列表
   - 高亮引用的关键段落
   - 显示相似度分数
   - 支持点击跳转到原文

3. 交互功能
   - 悬停显示完整段落
   - 点击打开原文档
   - 显示引用路径（查询->检索->Rerank->答案）

**UI设计**:
```
┌─────────────────────────────────────────┐
│  答案溯源链                               │
├─────────────────────────────────────────┤
│  问题：如何进行凭证审核？                 │
├─────────────────────────────────────────┤
│  答案：凭证审核是财务管理的重要环节...   │
├─────────────────────────────────────────┤
│  📎 引用来源（3个文档）                 │
│                                          │
│  1. 建账规则.md (相似度: 0.89)          │
│     > 凭证审核包括以下步骤：            │
│     > ...                               │
│     [查看更多] [打开文档]               │
│                                          │
│  2. 审核流程.docx (相似度: 0.82)       │
│     > 审核流程：1. 收集凭证...          │
│     > ...                               │
│     [查看更多] [打开文档]               │
│                                          │
│  3. 财务制度.pdf (相似度: 0.76)         │
│     > ...                               │
│     [查看更多] [打开文档]               │
└─────────────────────────────────────────┘
```

#### 4.3 智能对比模式
**状态**: 未开始
**预计时间**: 3-4小时
**依赖**: 2.1 RAG策略测试
**任务**:
- [ ] 实现多角色答案生成
- [ ] 实现答案对比展示
- [ ] 实现差异高亮
- [ ] 实现推荐最佳答案

**功能清单**:
1. 多角色生成
   - 使用4个角色视角生成答案
   - 产品经理、技术开发、销售运营、默认工程师

2. 对比展示
   - 并列显示4个答案
   - 高亮差异内容
   - 显示每个答案的特点

3. 智能推荐
   - 分析问题类型
   - 推荐最适合的角色视角
   - 提供选择建议

**UI设计**:
```
┌─────────────────────────────────────────┐
│  智能对比模式                             │
├─────────────────────────────────────────┤
│  问题：如何进行凭证审核？                 │
├─────────────────────────────────────────┤
│  📋 角色选择                             │
│  [☑] 产品经理  [☑] 技术开发  [☑] 销售运营 │
├─────────────────────────────────────────┤
│  🔄 对比结果                             │
│                                          │
│  ┌─────────────┬─────────────┬────────┐│
│  │产品经理     │技术开发      │销售运营 ││
│  ├─────────────┼─────────────┼────────┤│
│  │从产品角度... │从技术角度... │从商业... ││
│  │...          │...          │...     ││
│  └─────────────┴─────────────┴────────┘│
│                                          │
│  💡 推荐答案：技术开发视角                │
│  原因：这是一个技术实现问题...          │
└─────────────────────────────────────────┘
```

#### 4.4 批量问答测试
**状态**: 未开始
**预计时间**: 3-4小时
**依赖**: 2.1 RAG策略测试
**任务**:
- [ ] 实现问题列表上传
- [ ] 实现批量答案生成
- [ ] 实现进度展示
- [ ] 实现结果导出

**功能清单**:
1. 问题管理
   - 上传问题列表（文本/Excel/JSON）
   - 编辑问题
   - 保存问题模板

2. 批量处理
   - 并行生成答案
   - 显示处理进度
   - 支持暂停/恢复

3. 结果管理
   - 查看所有答案
   - 评分和标注
   - 导出结果（Excel/JSON/PDF）

**API端点**:
- `POST /api/batch/upload` - 上传问题列表
- `POST /api/batch/generate` - 批量生成答案
- `GET /api/batch/progress/<job_id>` - 获取进度
- `GET /api/batch/results/<job_id>` - 获取结果
- `POST /api/batch/export/<job_id>` - 导出结果

**UI设计**:
```
┌─────────────────────────────────────────┐
│  批量问答测试                             │
├─────────────────────────────────────────┤
│  📤 上传问题列表                         │
│  [选择文件] 或 [粘贴问题]               │
├─────────────────────────────────────────┤
│  ⚙️ 配置选项                              │
│  - 角色: [技术开发 ▼]                  │
│  - 检索策略: [自动 ▼]                  │
│  - 并发数: [5 ▼]                       │
├─────────────────────────────────────────┤
│  🚀 开始批量生成 [开始生成]              │
├─────────────────────────────────────────┤
│  📊 处理进度 (15/50)                    │
│  ████████░░░░░░░░░░░░░ 30%            │
│                                          │
│  ┌─────────────────────────────────┐   │
│  │ [✓] 1. 如何进行凭证审核？      │   │
│  │     [查看答案] [评分]           │   │
│  ├─────────────────────────────────┤   │
│  │ [✓] 2. 建账的基本原则是什么？    │   │
│  │     [查看答案] [评分]           │   │
│  ├─────────────────────────────────┤   │
│  │ [⏳] 3. 余额不平衡如何处理？     │   │
│  │     [处理中...]                 │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  📥 导出结果 [导出Excel] [导出JSON]     │
└─────────────────────────────────────────┘
```

#### 4.5 知识库差异分析
**状态**: 未开始
**预计时间**: 4-5小时
**依赖**: 3.1 知识库管理基础功能
**任务**:
- [ ] 实现文档对比功能
- [ ] 实现知识点提取
- [ ] 实现差异可视化
- [ ] 实现合并建议

**功能清单**:
1. 文档对比
   - 选择2个或多个文档
   - 对比文档内容
   - 识别差异

2. 知识点提取
   - 提取文档中的知识点
   - 识别关键信息
   - 分类知识点

3. 差异分析
   - 识别新增知识点
   - 识别删除知识点
   - 识别修改知识点

4. 可视化
   - 差异高亮
   - 知识点树状图
   - 合并建议

**API端点**:
- `POST /api/diff/compare` - 对比文档
- `POST /api/diff/extract` - 提取知识点
- `GET /api/diff/report/<diff_id>` - 获取差异报告

**UI设计**:
```
┌─────────────────────────────────────────┐
│  知识库差异分析                           │
├─────────────────────────────────────────┤
│  📄 选择文档                             │
│  文档A: [建账规则-v1.md ▼]              │
│  文档B: [建账规则-v2.md ▼]              │
│  [开始对比]                             │
├─────────────────────────────────────────┤
│  📊 对比结果                             │
│                                          │
│  差异统计：                               │
│  - 新增知识点: 5                        │
│  - 删除知识点: 2                        │
│  - 修改知识点: 8                        │
│                                          │
│  🆕 新增知识点：                          │
│  1. 凭证审核的电子化流程                │
│  2. 自动化对账功能                      │
│  ...                                    │
│                                          │
│  ❌ 删除知识点：                          │
│  1. 手工对账流程                        │
│  2. ...                                │
│                                          │
│  ✏️ 修改知识点：                          │
│  1. 审核周期: 7天 → 5天                │
│  2. ...                                │
├─────────────────────────────────────────┤
│  💡 合并建议                             │
│  [合并文档] [生成报告] [导出]          │
└─────────────────────────────────────────┘
```

---

### 优先级5：优化和完善

#### 5.1 性能优化
**状态**: 未开始
**预计时间**: 4-6小时
**任务**:
- [ ] 优化向量检索速度（索引优化、缓存）
- [ ] 优化BM25索引（增量更新）
- [ ] 优化批量检索性能（并发控制）
- [ ] 优化Web响应速度（CDN、压缩）
- [ ] 数据库查询优化

#### 5.2 错误处理和日志
**状态**: 部分完成
**预计时间**: 2-3小时
**任务**:
- [ ] 完善错误提示信息
- [ ] 添加详细日志记录
- [ ] 实现错误监控
- [ ] 添加性能监控
- [ ] 用户行为追踪

#### 5.3 文档和帮助
**状态**: 未开始
**预计时间**: 2-3小时
**任务**:
- [ ] 编写用户使用手册
- [ ] 编写API文档
- [ ] 编写开发者文档
- [ ] 添加界面帮助提示
- [ ] 录制使用教程视频

#### 5.4 部署和运维
**状态**: 未开始
**预计时间**: 4-6小时
**任务**:
- [ ] 容器化部署（Docker）
- [ ] 配置自动化部署（CI/CD）
- [ ] 配置数据库备份
- [ ] 配置监控告警
- [ ] 配置安全策略

---

## 🔧 技术债务清单

### 代码层面
1. **动态导入问题**
   - 部分工具使用动态导入避免LSP错误
   - 建议：创建类型声明文件（.pyi）

2. **错误处理不完善**
   - 部分函数缺少异常处理
   - 建议：统一错误处理机制

3. **类型注解不完整**
   - 部分函数缺少类型注解
   - 建议：添加完整类型注解

### 架构层面
1. **数据库依赖**
   - 当前依赖PostgreSQL + PGVector
   - 建议：支持多种向量存储（Chroma, Pinecone等）

2. **缓存机制**
   - BM25索引已缓存，但向量检索未缓存
   - 建议：实现查询结果缓存

3. **并发控制**
   - 批量检索未限制并发数
   - 建议：实现并发控制机制

### 测试层面
1. **单元测试不足**
   - 仅端到端测试，缺少单元测试
   - 建议：使用pytest编写单元测试

2. **集成测试缺失**
   - 缺少完整的集成测试
   - 建议：编写集成测试用例

---

## 📅 开发时间估算

### 短期目标（1-2周）
- 优先级1：数据库配置（2-3小时）
- 优先级2：完整功能测试（5-7小时）
- **总计**: 7-10小时

### 中期目标（2-4周）
- 优先级3：知识库管理功能（10-13小时）
- 优先级4：特色功能（14-19小时）
- **总计**: 24-32小时

### 长期目标（1-2个月）
- 优先级5：优化和完善（12-18小时）
- 技术债务清理（8-12小时）
- 文档和部署（6-9小时）
- **总计**: 26-39小时

### 总体估算
- **最小工作量**: 37小时
- **最大工作量**: 81小时
- **推荐时间线**: 1.5-2个月

---

## 🎯 下一步行动计划

### 明天开始的工作（Day 1）
1. **数据库配置**（优先级1）
   - 09:00-11:00：配置PostgreSQL + PGVector
   - 11:00-12:00：添加示例文档，测试基础功能
   - 14:00-17:00：RAG策略端到端测试

2. **Web界面测试**（优先级2）
   - 17:00-18:00：测试RAG配置界面
   - 18:00-19:00：修复发现的bug

### 本周目标（Week 1）
- 完成数据库配置和基础测试
- 完成RAG策略功能测试
- 完成Web界面测试
- 修复所有发现的bug
- **目标**: 所有核心功能可用

### 下周目标（Week 2）
- 完成知识库管理基础功能
- 完成文档分层结构
- 完成分段预览功能
- **目标**: 知识库管理功能完整

### 本月目标（Month 1）
- 完成所有特色功能（知识热力图、答案溯源、智能对比、批量测试、差异分析）
- 完成性能优化
- 完成错误处理和日志
- **目标**: 功能完善，用户体验优化

---

## 📝 备注

### 已知问题
1. PGVector数据库未配置，导致向量检索功能不可用
2. Web界面的RAG配置功能未测试
3. 部分高级功能未实现（知识热力图、答案溯源等）

### 技术限制
1. 当前仅支持PostgreSQL + PGVector向量存储
2. Embedding和Rerank使用API，需要网络连接
3. WebSocket服务需要额外配置

### 扩展性建议
1. 支持更多向量存储（Chroma, Pinecone, Weaviate）
2. 支持更多Embedding模型（OpenAI, Cohere等）
3. 支持更多文档格式（PDF, TXT, HTML等）
4. 支持多租户和权限管理
5. 支持API网关和微服务架构

---

## ✨ 总结

### 项目亮点
1. ✅ 完整实现了Dify工作流的迁移
2. ✅ 实现了灵活的RAG策略系统（7种问题类型、4种检索策略）
3. ✅ 提供了完整的Web可视化界面
4. ✅ 支持实时协作会话功能
5. ✅ 使用API方案，无需本地模型

### 待完成重点
1. ⏳ 数据库配置（阻塞项）
2. ⏳ 知识库管理功能
3. ⏳ 特色功能（热力图、溯源、对比等）
4. ⏳ 测试和优化

### 成功标准
- 所有RAG策略功能正常工作
- 知识库管理功能完善
- Web界面用户体验良好
- 性能满足生产环境要求
- 文档完整，易于维护

---

**文档版本**: v1.0
**最后更新**: 2025-01
**维护者**: Coze Coding Team
